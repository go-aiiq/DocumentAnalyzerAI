<div class="project-container">
  <!-- Sidebar -->
   <button 
      mat-icon-button
      (click)="toggleSidebar()"
      aria-label="Toggle sidebar"
      class="toggle-btn"
      [ngClass]="{ 'left': isCollapsed, 'right': !isCollapsed }"
      >
        <mat-icon *ngIf="isCollapsed">menu</mat-icon>
        <mat-icon *ngIf="!isCollapsed">arrow_circle_left</mat-icon>
      </button>
  <aside class="project-sidebar" [class.collapsed]="isCollapsed">
     <ng-container *ngIf="!isCollapsed">
    <div class="sidebar-header">
      <h2>Property Hub</h2>
      
      <button mat-raised-button class="create-btn" (click)="openCreateDialog()">
        <mat-icon>add</mat-icon> New Property
      </button>
    </div>

    <mat-nav-list class="project-list">
      <mat-list-item class="dashboard-item"
        [class.active]="'Project' === selectedFolder"
        (click)="selectFolder('Project')">
        <mat-icon matListIcon>dashboard</mat-icon>
        <span class="folder-name">Dashboard</span>
      </mat-list-item>

      <mat-divider></mat-divider>
      
      <h3 class="sidebar-section-title">My Properties</h3>
      
      <mat-list-item 
        *ngFor="let folder of folderNames"
        [class.active]="folder === selectedFolder"
        (click)="$event.stopPropagation(); selectFolder(folder)"
        class="dashboard-item">
        <div class="folder-content">
          <div class="folder-header">
            <span class="folder-name">{{ folder }}</span>
            <!-- <span class="file-count" *ngIf="getFileCount(folder) > 0">
              {{ getFileCount(folder) }}
            </span> -->
          </div>
          <button mat-icon-button 
                  class="delete-folder" 
                  (click)="$event.stopPropagation(); confirmDeleteFolder(folder)"
                  matTooltip="Delete folder">
            <mat-icon>delete_outline</mat-icon>
          </button>
        </div>
      </mat-list-item>
      
      <div *ngIf="folderNames.length === 0" class="no-projects">
        <mat-icon>create_new_folder</mat-icon>
        <p>No properties yet</p>
        <button mat-button color="primary" (click)="openCreateDialog()">
          Create your first property transaction
        </button>
      </div>
    </mat-nav-list>
    </ng-container>
  </aside>

  <!-- Main Content -->
  <main class="project-content">
    <ng-container *ngIf="selectedFolder; else noFolderSelected">
      <div class="file-list">
        
        <ng-container *ngIf="selectedFolder !== 'Project'; else dashboardView">
          <div style="display: flex; align-items: center; justify-content: space-between;">
          
          <h3>Files in "{{ selectedFolder }}"</h3> 
          <button mat-raised-button class="outlined-button" (click)="scrollToTarget()">
          <mat-icon>arrow_downward</mat-icon> Scroll to Section
          </button>
          </div>         
        </ng-container>
        <ng-template #dashboardView>
          <h3>Dashboard: {{ getTotalPropertiesCount() }} {{ getTotalPropertiesCount() === 1 ? 'Property' : 'Properties' }}</h3>
        </ng-template>
        <div class="upload-box" *ngIf="selectedFolder !== 'Project' && folderNames.length > 0">
          <div class="upload-options">
            <input type="file" #fileInput style="display: none" (change)="onFileSelected($event)" accept=".pdf" multiple>
            <button mat-raised-button color="primary" (click)="fileInput.click()" [disabled]="loading">
              <mat-icon>cloud_upload</mat-icon>
              {{ loading ? 'Uploading...' : 'Upload Files' }}
            </button>
            
            <!-- Upload results -->
            <div class="upload-results" *ngIf="uploadResults.length > 0">
              <div class="upload-result" *ngFor="let result of uploadResults">
                <div class="file-header">
                  <mat-icon class="file-icon" [class.success]="result.success" [class.error]="!result.success">
                    {{ result.success ? 'check_circle' : 'error' }}
                  </mat-icon>
                  <div class="file-details">
                    <span class="file-name" [title]="result.file.name">{{ result.file.name }}</span>
                    <span class="file-size">{{ getFileSize(result.file.size) }}</span>
                  </div>
                </div>
                
                <div class="upload-progress">
                  <div class="progress-bar-container">
                    <mat-progress-bar 
                      [mode]="result.progress < 100 ? 'determinate' : 'determinate'"
                      [value]="result.progress"
                      [color]="result.success ? 'primary' : 'warn'">
                    </mat-progress-bar>
                    <span class="progress-text" *ngIf="result.progress > 0">
                      {{ result.progress | number:'1.0-0' }}%
                    </span>
                  </div>
                  <div class="upload-status" [class.success]="result.success" [class.error]="!result.success">
                    <span *ngIf="!result.success && !result.message">Uploading...</span>
                    <span *ngIf="result.message">{{ result.message }}</span>
                  </div>
                </div>
              </div>
            </div>
           
        </div>
          </div>
          
          

        <mat-list class="list-items" *ngIf="processedFolders[selectedFolder]?.length; else noFiles">
          <ng-container *ngFor="let file of processedFolders[selectedFolder]">
            <mat-expansion-panel>
              <mat-expansion-panel-header style="height: fit-content;">
                <mat-list-item class="file-list-item">
                  <div class="file-content">
                    <div class="file-info">
                      <div class="file-name">
                        <span class="filename-text">{{ getFileName(file.key) }}</span>
                        <small *ngIf="file.size !== undefined" class="file-size">{{ file.size | filesize }}</small>
                      </div>
                    </div>
    
                    <div class="file-actions">
                      <ng-container >
                        
                      
                      <span matTooltip="Processing..." matTooltipPosition="below">
                        
                         <div class="spinner-wrapper" *ngIf="processingMap[file.url]">
                          <mat-spinner *ngIf="processingMap[file.url]" diameter="25"></mat-spinner>
                         <div class="progress-label">{{ processProgress }}%</div>
                         <!-- <mat-progress-spinner 
                              mode="determinate"
                              [value]="processProgress"
                              color="primary"
                              diameter="25"
                              strokeWidth="3">
                            </mat-progress-spinner>
                            <div class="progress-label">{{ processProgress }}%</div> -->
                             <!-- <div class="checkmark" *ngIf="showCheckmark">
                                <span>  ✔️</span> -->
                             <!-- </div>  -->
                            </div>
                      </span>
                      <button mat-icon-button
                              matTooltip="Process"
                              matTooltipPosition="below"
                              [disabled]="processingMap[file.url]"
                              (click)="$event.stopPropagation(); processDocument(file.url)">
                        <mat-icon>sync</mat-icon>
                      </button>
                      </ng-container>
                      
    
                      <ng-container *ngIf="file.hasError && !file.isProcessing">
                        <mat-icon color="warn" matTooltip="Error processing file">error</mat-icon>
                      </ng-container>
    
                      <a (click)="$event.stopPropagation();" [href]="file.url" download>
                        <button mat-icon-button matTooltip="Download" matTooltipPosition="below">
                          <mat-icon>download</mat-icon>
                        </button>
                      </a>
                      <button mat-icon-button matTooltip="Delete" matTooltipPosition="below" (click)="$event.stopPropagation(); deleteFile(file.key)" *ngIf="!file.isProcessing">
                        <mat-icon>delete</mat-icon>
                      </button>
                    </div>
                  </div>
                </mat-list-item>
              </mat-expansion-panel-header>
              <app-results [filePath]='file.url' ></app-results>
            </mat-expansion-panel>
          </ng-container>
        </mat-list>

        <ng-template #noFiles>
          <div class="empty-state" *ngIf="selectedFolder !== 'Project'">
            <mat-icon>folder_open</mat-icon>
            <p>No files available in this folder.</p>
          </div>
        </ng-template>
      </div>
    </ng-container>

    <ng-template #noFolderSelected>
      <div class="no-folder-selected">
        <mat-icon>folder_open</mat-icon>
        <h3>Select a project or create a new one to get started</h3>
      </div>
    </ng-template>
     <div *ngIf="selectedFolder" [attr.data-key]="refreshKey" #targetDiv> 
     <app-pdf-viewer *ngIf="selectedFolder !== 'Project'" [selectedFolder]="processedFolders[selectedFolder]"></app-pdf-viewer>
     </div>
  </main>
</div>