<div class="project-container">
  <!-- Sidebar -->
  <aside class="project-sidebar">
    <div class="sidebar-header">
      <h2>Property Hub</h2>
      <button mat-raised-button class="create-btn" (click)="openCreateDialog()">
        <mat-icon>add</mat-icon> New Property
      </button>
    </div>

    <mat-nav-list class="project-list">
      <mat-list-item class="dashboard-item"
        [class.active]="'Project' === selectedFolder"
        (click)="selectFolder('Project')">
        <mat-icon matListIcon>dashboard</mat-icon>
        <span class="folder-name">Dashboard</span>
      </mat-list-item>

      <mat-divider></mat-divider>
      
      <h3 class="sidebar-section-title">My Properties</h3>
      
      <mat-list-item 
        *ngFor="let folder of folderNames"
        [class.active]="folder === selectedFolder"
        (click)="$event.stopPropagation(); selectFolder(folder)"
        class="dashboard-item">
        <div class="folder-content">
          <div class="folder-header">
            <span class="folder-name">{{ folder }}</span>
            <!-- <span class="file-count" *ngIf="getFileCount(folder) > 0">
              {{ getFileCount(folder) }}
            </span> -->
          </div>
          <button mat-icon-button 
                  class="delete-folder" 
                  (click)="$event.stopPropagation(); confirmDeleteFolder(folder)"
                  matTooltip="Delete folder">
            <mat-icon>delete_outline</mat-icon>
          </button>
        </div>
      </mat-list-item>
      
      <div *ngIf="folderNames.length === 0" class="no-projects">
        <mat-icon>create_new_folder</mat-icon>
        <p>No properties yet</p>
        <button mat-button color="primary" (click)="openCreateDialog()">
          Create your first property transaction
        </button>
      </div>
    </mat-nav-list>
  </aside>

  <!-- Main Content -->
  <main class="project-content">
    <ng-container *ngIf="selectedFolder; else noFolderSelected">
      <div class="file-list">
        
        <ng-container *ngIf="selectedFolder !== 'Project'; else dashboardView">
          <div style="display: flex; align-items: center; justify-content: space-between;">
          
          <h3>Files in "{{ selectedFolder }}"</h3> 
          <button mat-raised-button class="outlined-button" (click)="scrollToTarget()">
          <mat-icon>arrow_downward</mat-icon> Scroll to Section
          </button>
          </div>         
        </ng-container>
        <ng-template #dashboardView>
          <h3>Dashboard: {{ getTotalPropertiesCount() }} {{ getTotalPropertiesCount() === 1 ? 'Property' : 'Properties' }}</h3>
        </ng-template>
        <div class="upload-box" *ngIf="selectedFolder !== 'Project' && folderNames.length > 0">
          <div class="upload-options">
            <input type="file" #fileInput style="display: none" (change)="onFileSelected($event)" accept=".pdf" multiple>
            <button mat-raised-button color="primary" (click)="fileInput.click()" [disabled]="uploadProgress > 0 && uploadProgress < 100">
              <mat-icon>cloud_upload</mat-icon>
              {{ uploadProgress > 0 ? 'Uploading...' : 'Upload File' }}
            </button>
            
            <div class="file-info_upload" *ngIf="selectedFile" [class.uploading]="uploadProgress > 0">
              <div class="file-header">
                <mat-icon class="file-icon">description</mat-icon>
                <div class="file-details">
                  <span class="file-name" [title]="selectedFile.name">{{ selectedFile.name }}</span>
                  <span class="file-size">{{ getFileSize(selectedFile.size) }}</span>
                </div>
              </div>
              
              <div class="upload-progress" *ngIf="uploadProgress > 0">
                <div class="progress-bar-container">
                  <mat-progress-bar 
                    mode="determinate" 
                    [value]="uploadProgress"
                    color="primary">
                  </mat-progress-bar>
                  <span class="progress-text">{{ uploadProgress | number:'1.0-0' }}%</span>
                </div>
                <div class="upload-status">
                  <span *ngIf="uploadProgress < 100">Uploading...</span>
                  <span *ngIf="uploadProgress === 100" class="upload-success">
                    <mat-icon>check_circle</mat-icon>
                    Upload complete
                  </span>
                </div>
              </div>
            </div>
           
        </div>
          </div>
          
          

        <mat-list class="list-items" *ngIf="processedFolders[selectedFolder]?.length; else noFiles">
          <ng-container *ngFor="let file of processedFolders[selectedFolder]">
            <mat-list-item class="file-list-item">
              <div class="file-content">
                <div class="file-info">
                  <div class="file-name">
                    <span class="filename-text">{{ getFileName(file.key) }}</span>
                    <small *ngIf="file.size !== undefined" class="file-size">{{ file.size | filesize }}</small>
                  </div>
                </div>

                <div class="file-actions">
                  <ng-container >
                    
                  
                  <span matTooltip="Processing..." matTooltipPosition="below">
                    <mat-spinner *ngIf="processingMap[file.url]" diameter="25"></mat-spinner>
                  </span>
                  <button mat-icon-button
                          matTooltip="Process"
                          matTooltipPosition="below"
                          [disabled]="processingMap[file.url]"
                          (click)="processDocument(file.url)">
                    <mat-icon>sync</mat-icon>
                  </button>
                  </ng-container>
                  

                  <ng-container *ngIf="file.hasError && !file.isProcessing">
                    <mat-icon color="warn" matTooltip="Error processing file">error</mat-icon>
                  </ng-container>

                  <ng-container *ngIf="file.hasJson || viewEnabledMap[file.url]">
                    <button mat-icon-button matTooltip="View" matTooltipPosition="below" (click)="viewResults(file.url)" [disabled]="processingMap[file.url]">
                      <mat-icon>visibility</mat-icon>
                    </button>
                  </ng-container>

                  <a [href]="file.url" download>
                    <button mat-icon-button matTooltip="Download" matTooltipPosition="below">
                      <mat-icon>cloud_download</mat-icon>
                    </button>
                  </a>
                  <button mat-icon-button matTooltip="Delete" matTooltipPosition="below" (click)="deleteFile(file.key)" *ngIf="!file.isProcessing">
                    <mat-icon>delete</mat-icon>
                  </button>
                </div>
              </div>
            </mat-list-item>
          </ng-container>
        </mat-list>

        <ng-template #noFiles>
          <div class="empty-state" *ngIf="selectedFolder !== 'Project'">
            <mat-icon>folder_open</mat-icon>
            <p>No files available in this folder.</p>
          </div>
        </ng-template>
      </div>
    </ng-container>

    <ng-template #noFolderSelected>
      <div class="no-folder-selected">
        <mat-icon>folder_open</mat-icon>
        <h3>Select a project or create a new one to get started</h3>
      </div>
    </ng-template>
     <div *ngIf="selectedFolder" [attr.data-key]="refreshKey" #targetDiv> 
     <app-pdf-viewer *ngIf="selectedFolder !== 'Project'" [selectedFolder]="processedFolders[selectedFolder]"></app-pdf-viewer>
     </div>
  </main>
</div>